<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Inventario Automatizado</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Archivo:wght@300;400;600;700&family=JetBrains+Mono:wght@400;600&display=swap');
        
        :root {
            --bg-primary: #0a0e17;
            --bg-secondary: #131826;
            --bg-card: #1a2030;
            --accent-primary: #00d4ff;
            --accent-secondary: #7c3aed;
            --accent-danger: #ef4444;
            --accent-warning: #f59e0b;
            --accent-success: #10b981;
            --text-primary: #e2e8f0;
            --text-secondary: #94a3b8;
            --border: #2d3748;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Archivo', sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.6;
            overflow-x: hidden;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 2rem;
        }

        /* Header */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 3rem;
            padding-bottom: 2rem;
            border-bottom: 2px solid var(--border);
        }

        .header h1 {
            font-size: 2.5rem;
            font-weight: 700;
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .header-actions {
            display: flex;
            gap: 1rem;
        }

        /* Buttons */
        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 8px;
            font-family: 'Archivo', sans-serif;
            font-weight: 600;
            font-size: 0.95rem;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(0, 212, 255, 0.3);
        }

        .btn-secondary {
            background: var(--bg-card);
            color: var(--text-primary);
            border: 1px solid var(--border);
        }

        .btn-secondary:hover {
            background: var(--bg-secondary);
            border-color: var(--accent-primary);
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 3rem;
        }

        .stat-card {
            background: var(--bg-card);
            padding: 1.5rem;
            border-radius: 12px;
            border: 1px solid var(--border);
            position: relative;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, var(--accent-primary), var(--accent-secondary));
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 40px rgba(0, 212, 255, 0.15);
        }

        .stat-label {
            font-size: 0.85rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 0.5rem;
        }

        .stat-value {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--accent-primary);
            font-family: 'JetBrains Mono', monospace;
        }

        .stat-change {
            font-size: 0.85rem;
            margin-top: 0.5rem;
        }

        .stat-change.positive {
            color: var(--accent-success);
        }

        .stat-change.negative {
            color: var(--accent-danger);
        }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 1rem;
            margin-bottom: 2rem;
            border-bottom: 1px solid var(--border);
        }

        .tab {
            padding: 1rem 2rem;
            background: none;
            border: none;
            color: var(--text-secondary);
            font-family: 'Archivo', sans-serif;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            position: relative;
            transition: color 0.3s ease;
        }

        .tab.active {
            color: var(--accent-primary);
        }

        .tab.active::after {
            content: '';
            position: absolute;
            bottom: -1px;
            left: 0;
            right: 0;
            height: 2px;
            background: linear-gradient(90deg, var(--accent-primary), var(--accent-secondary));
        }

        /* Content Area */
        .content {
            background: var(--bg-card);
            border-radius: 12px;
            border: 1px solid var(--border);
            padding: 2rem;
            min-height: 500px;
        }

        .tab-content {
            display: none;
            animation: fadeIn 0.3s ease;
        }

        .tab-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Table */
        .table-container {
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        thead {
            background: var(--bg-secondary);
        }

        th {
            padding: 1rem;
            text-align: left;
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            font-size: 0.85rem;
            letter-spacing: 0.5px;
        }

        td {
            padding: 1rem;
            border-bottom: 1px solid var(--border);
        }

        tbody tr {
            transition: background 0.2s ease;
        }

        tbody tr:hover {
            background: var(--bg-secondary);
        }

        /* Badge */
        .badge {
            display: inline-block;
            padding: 0.35rem 0.75rem;
            border-radius: 6px;
            font-size: 0.8rem;
            font-weight: 600;
            font-family: 'JetBrains Mono', monospace;
        }

        .badge-success {
            background: rgba(16, 185, 129, 0.2);
            color: var(--accent-success);
        }

        .badge-warning {
            background: rgba(245, 158, 11, 0.2);
            color: var(--accent-warning);
        }

        .badge-danger {
            background: rgba(239, 68, 68, 0.2);
            color: var(--accent-danger);
        }

        .badge-info {
            background: rgba(0, 212, 255, 0.2);
            color: var(--accent-primary);
        }

        /* Forms */
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        label {
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        input, select {
            padding: 0.75rem;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text-primary);
            font-family: 'Archivo', sans-serif;
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        input:focus, select:focus {
            outline: none;
            border-color: var(--accent-primary);
            box-shadow: 0 0 0 3px rgba(0, 212, 255, 0.1);
        }

        /* Alert Box */
        .alert {
            padding: 1rem 1.5rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 1rem;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from { transform: translateX(-20px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        .alert-warning {
            background: rgba(245, 158, 11, 0.15);
            border: 1px solid rgba(245, 158, 11, 0.3);
            color: var(--accent-warning);
        }

        .alert-danger {
            background: rgba(239, 68, 68, 0.15);
            border: 1px solid rgba(239, 68, 68, 0.3);
            color: var(--accent-danger);
        }

        /* Charts */
        .chart-container {
            background: var(--bg-secondary);
            padding: 1.5rem;
            border-radius: 8px;
            margin-top: 2rem;
            height: 300px;
        }

        /* Loading */
        .loading {
            text-align: center;
            padding: 3rem;
            color: var(--text-secondary);
        }

        .spinner {
            border: 3px solid var(--border);
            border-top: 3px solid var(--accent-primary);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Action Icons */
        .action-icon {
            cursor: pointer;
            padding: 0.5rem;
            border-radius: 6px;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }

        .action-icon:hover {
            background: var(--bg-secondary);
            transform: scale(1.1);
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 4rem 2rem;
            color: var(--text-secondary);
        }

        .empty-state-icon {
            font-size: 4rem;
            margin-bottom: 1rem;
            opacity: 0.3;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(5px);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            animation: fadeIn 0.3s ease;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 2rem;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            animation: slideUp 0.3s ease;
        }

        @keyframes slideUp {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--border);
        }

        .modal-header h2 {
            margin: 0;
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--text-secondary);
            padding: 0.5rem;
            border-radius: 6px;
            transition: all 0.2s ease;
        }

        .modal-close:hover {
            background: var(--bg-secondary);
            color: var(--text-primary);
        }

        .import-options {
            display: grid;
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .import-option {
            padding: 1.5rem;
            background: var(--bg-secondary);
            border: 2px solid var(--border);
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .import-option:hover {
            border-color: var(--accent-primary);
            transform: translateX(5px);
            background: linear-gradient(135deg, rgba(0, 212, 255, 0.05), rgba(124, 58, 237, 0.05));
        }

        .import-option-icon {
            font-size: 2rem;
        }

        .import-option-content h3 {
            margin: 0 0 0.5rem 0;
            color: var(--text-primary);
        }

        .import-option-content p {
            margin: 0;
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        .file-upload-area {
            border: 2px dashed var(--border);
            border-radius: 12px;
            padding: 2rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 1rem;
        }

        .file-upload-area:hover {
            border-color: var(--accent-primary);
            background: rgba(0, 212, 255, 0.05);
        }

        .file-upload-area.dragging {
            border-color: var(--accent-primary);
            background: rgba(0, 212, 255, 0.1);
        }

        #fileInput {
            display: none;
        }

        textarea {
            width: 100%;
            min-height: 200px;
            padding: 1rem;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text-primary);
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.9rem;
            resize: vertical;
        }

        textarea:focus {
            outline: none;
            border-color: var(--accent-primary);
            box-shadow: 0 0 0 3px rgba(0, 212, 255, 0.1);
        }

        .info-box {
            background: rgba(0, 212, 255, 0.1);
            border: 1px solid rgba(0, 212, 255, 0.3);
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
            font-size: 0.9rem;
            color: var(--text-secondary);
        }

        .info-box code {
            background: var(--bg-secondary);
            padding: 0.2rem 0.5rem;
            border-radius: 4px;
            color: var(--accent-primary);
            font-family: 'JetBrains Mono', monospace;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>üìä Sistema de Inventario</h1>
            <div class="header-actions">
                <button class="btn btn-secondary" onclick="showImportModal()">
                    üì§ Importar Datos
                </button>
                <button class="btn btn-secondary" onclick="exportData()">
                    üì• Exportar Datos
                </button>
                <button class="btn btn-primary" onclick="showAddProductModal()">
                    ‚ûï Agregar Producto
                </button>
            </div>
        </div>

        <!-- Stats Grid -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-label">Total Productos</div>
                <div class="stat-value" id="totalProducts">0</div>
                <div class="stat-change positive" id="productsChange">+0 este mes</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Alertas Activas</div>
                <div class="stat-value" id="totalAlerts">0</div>
                <div class="stat-change" id="alertsInfo">0 cr√≠ticas</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Valor Inventario</div>
                <div class="stat-value" id="inventoryValue">$0</div>
                <div class="stat-change positive" id="valueChange">+0%</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Stock Total</div>
                <div class="stat-value" id="totalStock">0</div>
                <div class="stat-change" id="stockInfo">0 unidades</div>
            </div>
        </div>

        <!-- Tabs -->
        <div class="tabs">
            <button class="tab active" onclick="switchTab('inventory')">üì¶ Inventario</button>
            <button class="tab" onclick="switchTab('alerts')">üîî Alertas</button>
            <button class="tab" onclick="switchTab('reports')">üìà Reportes</button>
            <button class="tab" onclick="switchTab('categories')">üè∑Ô∏è Categor√≠as</button>
        </div>

        <!-- Content -->
        <div class="content">
            <!-- Inventory Tab -->
            <div id="inventory-tab" class="tab-content active">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
                    <h2>Gesti√≥n de Inventario</h2>
                    <div style="display: flex; gap: 1rem;">
                        <input type="text" id="searchProduct" placeholder="üîç Buscar producto..." style="min-width: 300px;" oninput="filterProducts()">
                        <select id="filterCategory" onchange="filterProducts()">
                            <option value="">Todas las categor√≠as</option>
                        </select>
                    </div>
                </div>
                
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>C√≥digo</th>
                                <th>Producto</th>
                                <th>Categor√≠a</th>
                                <th>Stock Actual</th>
                                <th>Stock M√≠nimo</th>
                                <th>Stock M√°ximo</th>
                                <th>Estado</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="inventoryTableBody">
                            <!-- Dynamic content -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Alerts Tab -->
            <div id="alerts-tab" class="tab-content">
                <h2 style="margin-bottom: 2rem;">Centro de Alertas</h2>
                <div id="alertsContainer">
                    <!-- Dynamic alerts -->
                </div>
            </div>

            <!-- Reports Tab -->
            <div id="reports-tab" class="tab-content">
                <h2 style="margin-bottom: 2rem;">Reportes y An√°lisis</h2>
                <div class="form-grid" style="margin-bottom: 2rem;">
                    <div class="form-group">
                        <label>Per√≠odo</label>
                        <select id="reportPeriod" onchange="updateReports()">
                            <option value="week">√öltima Semana</option>
                            <option value="month" selected>√öltimo Mes</option>
                            <option value="quarter">√öltimo Trimestre</option>
                            <option value="year">√öltimo A√±o</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Tipo de Reporte</label>
                        <select id="reportType" onchange="updateReports()">
                            <option value="stock">Movimientos de Stock</option>
                            <option value="categories">Por Categor√≠as</option>
                            <option value="value">Valor de Inventario</option>
                        </select>
                    </div>
                </div>
                <div id="reportContent">
                    <!-- Dynamic reports -->
                </div>
            </div>

            <!-- Categories Tab -->
            <div id="categories-tab" class="tab-content">
                <h2 style="margin-bottom: 2rem;">Gesti√≥n de Categor√≠as</h2>
                <div class="form-grid">
                    <div class="form-group">
                        <label>Nueva Categor√≠a</label>
                        <input type="text" id="newCategory" placeholder="Nombre de la categor√≠a">
                    </div>
                    <div class="form-group">
                        <label>&nbsp;</label>
                        <button class="btn btn-primary" onclick="addCategory()">Agregar Categor√≠a</button>
                    </div>
                </div>
                <div id="categoriesList" style="margin-top: 2rem;">
                    <!-- Dynamic categories -->
                </div>
            </div>
        </div>
    </div>

    <!-- Import Modal -->
    <div id="importModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>üì§ Importar Datos</h2>
                <button class="modal-close" onclick="closeImportModal()">‚úï</button>
            </div>

            <div id="importStep1">
                <h3 style="margin-bottom: 1rem;">Selecciona el m√©todo de importaci√≥n:</h3>
                <div class="import-options">
                    <div class="import-option" onclick="showExcelImport()">
                        <div class="import-option-icon">üìä</div>
                        <div class="import-option-content">
                            <h3>Desde Excel/CSV</h3>
                            <p>Sube tu archivo Excel (.xlsx, .xls) o CSV</p>
                        </div>
                    </div>
                    <div class="import-option" onclick="showTextImport()">
                        <div class="import-option-icon">üìù</div>
                        <div class="import-option-content">
                            <h3>Copiar y Pegar</h3>
                            <p>Pega tus datos desde Excel o cualquier tabla</p>
                        </div>
                    </div>
                    <div class="import-option" onclick="showJsonImport()">
                        <div class="import-option-icon">üíæ</div>
                        <div class="import-option-content">
                            <h3>Importar JSON</h3>
                            <p>Para importar respaldos o datos estructurados</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Excel/CSV Import -->
            <div id="excelImportStep" style="display: none;">
                <button class="btn btn-secondary" onclick="backToImportOptions()" style="margin-bottom: 1rem;">
                    ‚Üê Volver
                </button>
                <h3 style="margin-bottom: 1rem;">Subir archivo Excel o CSV</h3>
                <div class="info-box">
                    <strong>üìã Formato esperado:</strong><br>
                    C√≥digo | Producto | Categor√≠a | Stock | M√≠nimo | M√°ximo<br>
                    <small>El archivo debe tener estas columnas en cualquier orden</small>
                </div>
                <div class="file-upload-area" id="fileUploadArea" onclick="document.getElementById('fileInput').click()">
                    <div style="font-size: 3rem; margin-bottom: 1rem;">üìÅ</div>
                    <p style="color: var(--text-primary); font-weight: 600; margin-bottom: 0.5rem;">
                        Haz clic o arrastra tu archivo aqu√≠
                    </p>
                    <p style="color: var(--text-secondary); font-size: 0.9rem;">
                        Soporta: .xlsx, .xls, .csv
                    </p>
                </div>
                <input type="file" id="fileInput" accept=".xlsx,.xls,.csv" onchange="handleFileUpload(event)">
                <div id="filePreview"></div>
            </div>

            <!-- Text Import -->
            <div id="textImportStep" style="display: none;">
                <button class="btn btn-secondary" onclick="backToImportOptions()" style="margin-bottom: 1rem;">
                    ‚Üê Volver
                </button>
                <h3 style="margin-bottom: 1rem;">Copiar y Pegar desde Excel</h3>
                <div class="info-box">
                    <strong>üìã Instrucciones:</strong><br>
                    1. Selecciona tus datos en Excel (incluye encabezados)<br>
                    2. Copia (Ctrl+C o Cmd+C)<br>
                    3. Pega aqu√≠ abajo<br>
                    <br>
                    <strong>Formato:</strong> C√≥digo, Producto, Categor√≠a, Stock, M√≠nimo, M√°ximo
                </div>
                <textarea id="pasteArea" placeholder="C√≥digo	Producto	Categor√≠a	Stock	M√≠nimo	M√°ximo
111000	CHICKEN TENDER	APANADOS	735	225	760
111001	CRISPETAS POLLO	APANADOS	334	249	545"></textarea>
                <button class="btn btn-primary" onclick="processTextImport()" style="width: 100%; margin-top: 1rem;">
                    ‚úÖ Importar Datos
                </button>
            </div>

            <!-- JSON Import -->
            <div id="jsonImportStep" style="display: none;">
                <button class="btn btn-secondary" onclick="backToImportOptions()" style="margin-bottom: 1rem;">
                    ‚Üê Volver
                </button>
                <h3 style="margin-bottom: 1rem;">Importar desde JSON</h3>
                <div class="info-box">
                    <strong>üìã Formato JSON:</strong><br>
                    <code>[{code: "111000", name: "...", category: "...", stock: 100, min: 50, max: 200}]</code>
                </div>
                <textarea id="jsonArea" placeholder='[
  {
    "code": "111000",
    "name": "CHICKEN TENDER CON PANKO",
    "category": "APANADOS",
    "stock": 735,
    "min": 225,
    "max": 760
  }
]'></textarea>
                <button class="btn btn-primary" onclick="processJsonImport()" style="width: 100%; margin-top: 1rem;">
                    ‚úÖ Importar JSON
                </button>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script>
        // Initialize storage and data
        let inventory = [];
        let categories = ['APANADOS', 'ACEITES', 'BEBIDAS', 'CARNES FRIAS', 'CONFITERIA', 'ESPECIALES', 'FRUTAS', 'MAQUILA', 'POLLO APANADO', 'SALSAS'];
        let lines = ['TURKY', 'AJUSTES PRECIO', 'IMPORTADOS', 'MP INSUMOS Y EMPAQUES', 'NACIONALES', 'SERVICIOS'];
        let revisions = ['AUMENTAR STOCK', 'OK', 'SOBRESTOCK'];
        
        // Load initial data from uploaded spreadsheet
        async function initializeData() {
            // Check if we have stored data
            try {
                const stored = await window.storage.get('inventory-data');
                if (stored && stored.value) {
                    const data = JSON.parse(stored.value);
                    inventory = data.inventory || [];
                    categories = data.categories || categories;
                } else {
                    // Initialize with sample data from the spreadsheet
                    inventory = generateSampleData();
                    await saveData();
                }
            } catch (e) {
                console.log('Initializing with sample data');
                inventory = generateSampleData();
                await saveData();
            }
            
            updateDashboard();
            renderInventoryTable();
            renderAlerts();
            renderCategories();
            populateCategoryFilter();
        }

        function generateSampleData() {
            const products = [
                { code: '111000', name: 'CHICKEN TENDER CON PANKO x300G-TURKY', category: 'APANADOS', stock: 735, min: 225, max: 760 },
                { code: '111001', name: 'CHICKEN TENDER CON PANKO x1KG-TURKY', category: 'APANADOS', stock: 334, min: 249, max: 545 },
                { code: '111003', name: 'CRISPETAS POLLO CON PANKO x1KG-TURKY', category: 'APANADOS', stock: 134, min: 79, max: 299 },
                { code: '111004', name: 'CRISPETAS POLLO CON PANKO x500G-TURKY', category: 'APANADOS', stock: 45, min: 16, max: 100 },
                { code: '111006', name: 'CUBOS POLLO CON PANKO x1KG-TURKY', category: 'APANADOS', stock: 208, min: 229, max: 393 },
                { code: '111007', name: 'CUBOS POLLO CON PANKO x300G-TURKY', category: 'APANADOS', stock: 467, min: 417, max: 651 },
                { code: '111009', name: 'FILETE PECHUGA CON PANKO x1.25KG-TURKY', category: 'APANADOS', stock: 31, min: 21, max: 97 },
                { code: '111010', name: 'FILETE PECHUGA CON PANKO x1KG/10-TURKY', category: 'APANADOS', stock: 107, min: 117, max: 218 }
            ];
            
            return products.map(p => ({
                ...p,
                line: lines[Math.floor(Math.random() * lines.length)],
                revision: p.stock < p.min ? 'AUMENTAR STOCK' : (p.stock > p.max ? 'SOBRESTOCK' : 'OK'),
                lastUpdated: new Date().toISOString()
            }));
        }

        async function saveData() {
            try {
                await window.storage.set('inventory-data', JSON.stringify({
                    inventory,
                    categories,
                    lastUpdate: new Date().toISOString()
                }));
            } catch (e) {
                console.error('Error saving data:', e);
            }
        }

        function updateDashboard() {
            // Total products
            document.getElementById('totalProducts').textContent = inventory.length;
            
            // Alerts
            const alerts = inventory.filter(p => p.revision !== 'OK');
            document.getElementById('totalAlerts').textContent = alerts.length;
            const critical = alerts.filter(p => p.stock < p.min).length;
            document.getElementById('alertsInfo').textContent = `${critical} cr√≠ticas`;
            
            // Total stock
            const totalStock = inventory.reduce((sum, p) => sum + p.stock, 0);
            document.getElementById('totalStock').textContent = totalStock.toLocaleString();
            document.getElementById('stockInfo').textContent = 'unidades';
            
            // Value (simulated)
            const value = totalStock * 15; // Average price per unit
            document.getElementById('inventoryValue').textContent = '$' + value.toLocaleString();
        }

        function renderInventoryTable() {
            const tbody = document.getElementById('inventoryTableBody');
            
            if (inventory.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="8">
                            <div class="empty-state">
                                <div class="empty-state-icon">üì¶</div>
                                <h3>No hay productos en el inventario</h3>
                                <p>Comienza agregando tu primer producto</p>
                            </div>
                        </td>
                    </tr>
                `;
                return;
            }
            
            tbody.innerHTML = inventory.map(product => {
                let statusBadge = '';
                if (product.stock < product.min) {
                    statusBadge = '<span class="badge badge-danger">‚ö†Ô∏è Stock Bajo</span>';
                } else if (product.stock > product.max) {
                    statusBadge = '<span class="badge badge-warning">üìä Sobrestock</span>';
                } else {
                    statusBadge = '<span class="badge badge-success">‚úì OK</span>';
                }
                
                return `
                    <tr>
                        <td><code style="color: var(--accent-primary);">${product.code}</code></td>
                        <td><strong>${product.name}</strong></td>
                        <td><span class="badge badge-info">${product.category}</span></td>
                        <td><strong>${product.stock}</strong></td>
                        <td>${product.min}</td>
                        <td>${product.max}</td>
                        <td>${statusBadge}</td>
                        <td>
                            <span class="action-icon" onclick="editProduct('${product.code}')" title="Editar">‚úèÔ∏è</span>
                            <span class="action-icon" onclick="deleteProduct('${product.code}')" title="Eliminar">üóëÔ∏è</span>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function renderAlerts() {
            const container = document.getElementById('alertsContainer');
            const alerts = inventory.filter(p => p.revision !== 'OK');
            
            if (alerts.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">‚úÖ</div>
                        <h3>¬°Todo en orden!</h3>
                        <p>No hay alertas activas en este momento</p>
                    </div>
                `;
                return;
            }
            
            const lowStock = alerts.filter(p => p.stock < p.min);
            const overStock = alerts.filter(p => p.stock > p.max);
            
            let html = '';
            
            if (lowStock.length > 0) {
                html += '<h3 style="color: var(--accent-danger); margin-bottom: 1rem;">üö® Stock Bajo</h3>';
                lowStock.forEach(p => {
                    html += `
                        <div class="alert alert-danger">
                            <div>
                                <strong>${p.name}</strong> (${p.code})<br>
                                <small>Stock actual: ${p.stock} | M√≠nimo requerido: ${p.min} | Faltan: ${p.min - p.stock} unidades</small>
                            </div>
                            <button class="btn btn-primary" onclick="quickUpdate('${p.code}', ${p.min + 50})">Reabastecer</button>
                        </div>
                    `;
                });
            }
            
            if (overStock.length > 0) {
                html += '<h3 style="color: var(--accent-warning); margin: 2rem 0 1rem;">üìä Sobrestock</h3>';
                overStock.forEach(p => {
                    html += `
                        <div class="alert alert-warning">
                            <div>
                                <strong>${p.name}</strong> (${p.code})<br>
                                <small>Stock actual: ${p.stock} | M√°ximo: ${p.max} | Exceso: ${p.stock - p.max} unidades</small>
                            </div>
                        </div>
                    `;
                });
            }
            
            container.innerHTML = html;
        }

        function renderCategories() {
            const container = document.getElementById('categoriesList');
            container.innerHTML = `
                <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 1rem;">
                    ${categories.map(cat => {
                        const count = inventory.filter(p => p.category === cat).length;
                        return `
                            <div class="stat-card">
                                <div class="stat-label">${cat}</div>
                                <div class="stat-value" style="font-size: 2rem;">${count}</div>
                                <div style="font-size: 0.85rem; color: var(--text-secondary);">productos</div>
                            </div>
                        `;
                    }).join('')}
                </div>
            `;
        }

        function populateCategoryFilter() {
            const select = document.getElementById('filterCategory');
            select.innerHTML = '<option value="">Todas las categor√≠as</option>' +
                categories.map(cat => `<option value="${cat}">${cat}</option>`).join('');
        }

        function filterProducts() {
            const search = document.getElementById('searchProduct').value.toLowerCase();
            const category = document.getElementById('filterCategory').value;
            
            const filtered = inventory.filter(p => {
                const matchSearch = !search || 
                    p.name.toLowerCase().includes(search) || 
                    p.code.toLowerCase().includes(search);
                const matchCategory = !category || p.category === category;
                return matchSearch && matchCategory;
            });
            
            const tbody = document.getElementById('inventoryTableBody');
            tbody.innerHTML = filtered.map(product => {
                let statusBadge = '';
                if (product.stock < product.min) {
                    statusBadge = '<span class="badge badge-danger">‚ö†Ô∏è Stock Bajo</span>';
                } else if (product.stock > product.max) {
                    statusBadge = '<span class="badge badge-warning">üìä Sobrestock</span>';
                } else {
                    statusBadge = '<span class="badge badge-success">‚úì OK</span>';
                }
                
                return `
                    <tr>
                        <td><code style="color: var(--accent-primary);">${product.code}</code></td>
                        <td><strong>${product.name}</strong></td>
                        <td><span class="badge badge-info">${product.category}</span></td>
                        <td><strong>${product.stock}</strong></td>
                        <td>${product.min}</td>
                        <td>${product.max}</td>
                        <td>${statusBadge}</td>
                        <td>
                            <span class="action-icon" onclick="editProduct('${product.code}')" title="Editar">‚úèÔ∏è</span>
                            <span class="action-icon" onclick="deleteProduct('${product.code}')" title="Eliminar">üóëÔ∏è</span>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function switchTab(tabName) {
            // Update tab buttons
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            event.target.classList.add('active');
            
            // Update tab content
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            document.getElementById(tabName + '-tab').classList.add('active');
            
            // Refresh content if needed
            if (tabName === 'alerts') renderAlerts();
            if (tabName === 'reports') updateReports();
            if (tabName === 'categories') renderCategories();
        }

        function showAddProductModal() {
            const code = prompt('C√≥digo del producto:');
            if (!code) return;
            
            const name = prompt('Nombre del producto:');
            if (!name) return;
            
            const category = prompt('Categor√≠a:\n' + categories.join(', '));
            if (!category) return;
            
            const stock = parseInt(prompt('Stock actual:'));
            const min = parseInt(prompt('Stock m√≠nimo:'));
            const max = parseInt(prompt('Stock m√°ximo:'));
            
            const newProduct = {
                code,
                name,
                category,
                stock,
                min,
                max,
                line: lines[0],
                revision: stock < min ? 'AUMENTAR STOCK' : (stock > max ? 'SOBRESTOCK' : 'OK'),
                lastUpdated: new Date().toISOString()
            };
            
            inventory.push(newProduct);
            saveData();
            updateDashboard();
            renderInventoryTable();
            alert('‚úÖ Producto agregado exitosamente');
        }

        function editProduct(code) {
            const product = inventory.find(p => p.code === code);
            if (!product) return;
            
            const newStock = parseInt(prompt(`Nuevo stock para ${product.name}:`, product.stock));
            if (isNaN(newStock)) return;
            
            product.stock = newStock;
            product.revision = newStock < product.min ? 'AUMENTAR STOCK' : (newStock > product.max ? 'SOBRESTOCK' : 'OK');
            product.lastUpdated = new Date().toISOString();
            
            saveData();
            updateDashboard();
            renderInventoryTable();
            renderAlerts();
        }

        function deleteProduct(code) {
            if (!confirm('¬øEst√°s seguro de eliminar este producto?')) return;
            
            inventory = inventory.filter(p => p.code !== code);
            saveData();
            updateDashboard();
            renderInventoryTable();
        }

        async function quickUpdate(code, newStock) {
            const product = inventory.find(p => p.code === code);
            if (!product) return;
            
            product.stock = newStock;
            product.revision = newStock < product.min ? 'AUMENTAR STOCK' : (newStock > product.max ? 'SOBRESTOCK' : 'OK');
            product.lastUpdated = new Date().toISOString();
            
            await saveData();
            updateDashboard();
            renderInventoryTable();
            renderAlerts();
            alert('‚úÖ Stock actualizado');
        }

        function addCategory() {
            const newCat = document.getElementById('newCategory').value.trim().toUpperCase();
            if (!newCat) {
                alert('‚ö†Ô∏è Ingresa un nombre para la categor√≠a');
                return;
            }
            
            if (categories.includes(newCat)) {
                alert('‚ö†Ô∏è Esta categor√≠a ya existe');
                return;
            }
            
            categories.push(newCat);
            saveData();
            renderCategories();
            populateCategoryFilter();
            document.getElementById('newCategory').value = '';
            alert('‚úÖ Categor√≠a agregada exitosamente');
        }

        function updateReports() {
            const period = document.getElementById('reportPeriod').value;
            const type = document.getElementById('reportType').value;
            const container = document.getElementById('reportContent');
            
            // Simple report generation
            if (type === 'categories') {
                const stats = categories.map(cat => {
                    const products = inventory.filter(p => p.category === cat);
                    const total = products.reduce((sum, p) => sum + p.stock, 0);
                    return { category: cat, count: products.length, stock: total };
                });
                
                container.innerHTML = `
                    <div style="display: grid; gap: 1rem;">
                        ${stats.map(s => `
                            <div style="display: flex; justify-content: space-between; align-items: center; padding: 1rem; background: var(--bg-secondary); border-radius: 8px;">
                                <div>
                                    <strong>${s.category}</strong><br>
                                    <small style="color: var(--text-secondary);">${s.count} productos</small>
                                </div>
                                <div style="text-align: right;">
                                    <div style="font-size: 1.5rem; font-weight: 700; color: var(--accent-primary);">${s.stock}</div>
                                    <small style="color: var(--text-secondary);">unidades</small>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `;
            } else {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üìä</div>
                        <h3>Generando reporte...</h3>
                        <p>Esta funci√≥n estar√° disponible pr√≥ximamente</p>
                    </div>
                `;
            }
        }

        function exportData() {
            const csv = [
                ['C√≥digo', 'Producto', 'Categor√≠a', 'Stock', 'M√≠nimo', 'M√°ximo', 'Estado'],
                ...inventory.map(p => [
                    p.code, p.name, p.category, p.stock, p.min, p.max, p.revision
                ])
            ].map(row => row.join(',')).join('\n');
            
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `inventario_${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            URL.revokeObjectURL(url);
        }

        // Import Modal Functions
        function showImportModal() {
            document.getElementById('importModal').classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        function closeImportModal() {
            document.getElementById('importModal').classList.remove('active');
            document.body.style.overflow = 'auto';
            backToImportOptions();
        }

        function backToImportOptions() {
            document.getElementById('importStep1').style.display = 'block';
            document.getElementById('excelImportStep').style.display = 'none';
            document.getElementById('textImportStep').style.display = 'none';
            document.getElementById('jsonImportStep').style.display = 'none';
        }

        function showExcelImport() {
            document.getElementById('importStep1').style.display = 'none';
            document.getElementById('excelImportStep').style.display = 'block';
        }

        function showTextImport() {
            document.getElementById('importStep1').style.display = 'none';
            document.getElementById('textImportStep').style.display = 'block';
        }

        function showJsonImport() {
            document.getElementById('importStep1').style.display = 'none';
            document.getElementById('jsonImportStep').style.display = 'block';
        }

        // Drag and drop functionality
        const fileUploadArea = document.getElementById('fileUploadArea');
        if (fileUploadArea) {
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                fileUploadArea.addEventListener(eventName, preventDefaults, false);
            });

            function preventDefaults(e) {
                e.preventDefault();
                e.stopPropagation();
            }

            ['dragenter', 'dragover'].forEach(eventName => {
                fileUploadArea.addEventListener(eventName, () => {
                    fileUploadArea.classList.add('dragging');
                });
            });

            ['dragleave', 'drop'].forEach(eventName => {
                fileUploadArea.addEventListener(eventName, () => {
                    fileUploadArea.classList.remove('dragging');
                });
            });

            fileUploadArea.addEventListener('drop', handleDrop);
        }

        function handleDrop(e) {
            const dt = e.dataTransfer;
            const files = dt.files;
            if (files.length > 0) {
                handleFileUpload({ target: { files } });
            }
        }

        // File upload handler
        async function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            const preview = document.getElementById('filePreview');
            preview.innerHTML = '<div class="loading"><div class="spinner"></div><p>Procesando archivo...</p></div>';

            try {
                const reader = new FileReader();
                
                reader.onload = function(e) {
                    try {
                        const data = e.target.result;
                        let workbook;
                        
                        if (file.name.endsWith('.csv')) {
                            // Parse CSV
                            const lines = data.split('\n');
                            const headers = lines[0].split(/[,\t]/);
                            const products = [];
                            
                            for (let i = 1; i < lines.length; i++) {
                                if (!lines[i].trim()) continue;
                                const values = lines[i].split(/[,\t]/);
                                if (values.length >= 6) {
                                    products.push({
                                        code: values[0]?.trim(),
                                        name: values[1]?.trim(),
                                        category: values[2]?.trim(),
                                        stock: parseInt(values[3]) || 0,
                                        min: parseInt(values[4]) || 0,
                                        max: parseInt(values[5]) || 0
                                    });
                                }
                            }
                            
                            processImportedData(products);
                        } else {
                            // Parse Excel
                            workbook = XLSX.read(data, { type: 'binary' });
                            const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                            const jsonData = XLSX.utils.sheet_to_json(firstSheet);
                            
                            const products = jsonData.map(row => {
                                // Try to find columns by various possible names
                                const code = row['C√≥digo'] || row['Codigo'] || row['Code'] || row['CODIGO'] || '';
                                const name = row['Producto'] || row['Product'] || row['Descripcion'] || row['PRODUCTO'] || '';
                                const category = row['Categor√≠a'] || row['Categoria'] || row['Category'] || row['CATEGORIA'] || '';
                                const stock = parseInt(row['Stock'] || row['Stock Actual'] || row['STOCK'] || 0);
                                const min = parseInt(row['M√≠nimo'] || row['Minimo'] || row['Min'] || row['MINIMO'] || 0);
                                const max = parseInt(row['M√°ximo'] || row['Maximo'] || row['Max'] || row['MAXIMO'] || 0);
                                
                                return { code, name, category, stock, min, max };
                            }).filter(p => p.code && p.name);
                            
                            processImportedData(products);
                        }
                    } catch (error) {
                        preview.innerHTML = `
                            <div class="alert alert-danger">
                                ‚ùå Error al procesar el archivo: ${error.message}
                            </div>
                        `;
                    }
                };

                if (file.name.endsWith('.csv')) {
                    reader.readAsText(file);
                } else {
                    reader.readAsBinaryString(file);
                }
            } catch (error) {
                preview.innerHTML = `
                    <div class="alert alert-danger">
                        ‚ùå Error al leer el archivo: ${error.message}
                    </div>
                `;
            }
        }

        // Process imported data
        async function processImportedData(products) {
            const preview = document.getElementById('filePreview');
            
            if (products.length === 0) {
                preview.innerHTML = `
                    <div class="alert alert-warning">
                        ‚ö†Ô∏è No se encontraron productos v√°lidos en el archivo
                    </div>
                `;
                return;
            }

            // Show preview
            preview.innerHTML = `
                <div style="margin-top: 1.5rem;">
                    <div class="alert alert-warning">
                        ‚úÖ Se encontraron ${products.length} productos
                    </div>
                    <div style="max-height: 300px; overflow-y: auto; background: var(--bg-secondary); border-radius: 8px; padding: 1rem; margin-bottom: 1rem;">
                        <table style="width: 100%; font-size: 0.85rem;">
                            <thead>
                                <tr>
                                    <th>C√≥digo</th>
                                    <th>Producto</th>
                                    <th>Stock</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${products.slice(0, 10).map(p => `
                                    <tr>
                                        <td><code>${p.code}</code></td>
                                        <td>${p.name}</td>
                                        <td>${p.stock}</td>
                                    </tr>
                                `).join('')}
                                ${products.length > 10 ? `<tr><td colspan="3" style="text-align: center; color: var(--text-secondary);">... y ${products.length - 10} m√°s</td></tr>` : ''}
                            </tbody>
                        </table>
                    </div>
                    <div style="display: flex; gap: 1rem;">
                        <button class="btn btn-secondary" style="flex: 1;" onclick="closeImportModal()">
                            Cancelar
                        </button>
                        <button class="btn btn-primary" style="flex: 1;" onclick="confirmImport(${JSON.stringify(products).replace(/"/g, '&quot;')})">
                            ‚úÖ Importar ${products.length} productos
                        </button>
                    </div>
                </div>
            `;
        }

        // Confirm import
        async function confirmImport(products) {
            try {
                // Add line and revision to products
                const processedProducts = products.map(p => ({
                    ...p,
                    line: lines[0],
                    revision: p.stock < p.min ? 'AUMENTAR STOCK' : (p.stock > p.max ? 'SOBRESTOCK' : 'OK'),
                    lastUpdated: new Date().toISOString()
                }));

                // Add to inventory (or replace if you want)
                const replace = confirm('¬øDeseas REEMPLAZAR todos los productos existentes o AGREGAR estos nuevos productos?\n\nOK = Reemplazar todo\nCancelar = Agregar a los existentes');
                
                if (replace) {
                    inventory = processedProducts;
                } else {
                    // Merge: update existing or add new
                    processedProducts.forEach(newProd => {
                        const existingIndex = inventory.findIndex(p => p.code === newProd.code);
                        if (existingIndex >= 0) {
                            inventory[existingIndex] = newProd;
                        } else {
                            inventory.push(newProd);
                        }
                    });
                }

                await saveData();
                updateDashboard();
                renderInventoryTable();
                renderAlerts();
                renderCategories();
                populateCategoryFilter();
                
                closeImportModal();
                alert(`‚úÖ ${processedProducts.length} productos importados exitosamente!`);
            } catch (error) {
                alert('‚ùå Error al importar: ' + error.message);
            }
        }

        // Text import (paste from Excel)
        function processTextImport() {
            const text = document.getElementById('pasteArea').value.trim();
            if (!text) {
                alert('‚ö†Ô∏è Por favor pega los datos primero');
                return;
            }

            try {
                const lines = text.split('\n');
                const products = [];

                for (let i = 1; i < lines.length; i++) {
                    if (!lines[i].trim()) continue;
                    const values = lines[i].split('\t'); // Excel uses tabs
                    
                    if (values.length >= 6) {
                        products.push({
                            code: values[0]?.trim(),
                            name: values[1]?.trim(),
                            category: values[2]?.trim(),
                            stock: parseInt(values[3]) || 0,
                            min: parseInt(values[4]) || 0,
                            max: parseInt(values[5]) || 0
                        });
                    }
                }

                if (products.length === 0) {
                    alert('‚ö†Ô∏è No se encontraron productos v√°lidos. Aseg√∫rate de incluir los encabezados y datos correctos.');
                    return;
                }

                processImportedData(products);
            } catch (error) {
                alert('‚ùå Error al procesar los datos: ' + error.message);
            }
        }

        // JSON import
        async function processJsonImport() {
            const jsonText = document.getElementById('jsonArea').value.trim();
            if (!jsonText) {
                alert('‚ö†Ô∏è Por favor ingresa el JSON primero');
                return;
            }

            try {
                const products = JSON.parse(jsonText);
                
                if (!Array.isArray(products)) {
                    alert('‚ö†Ô∏è El JSON debe ser un array de productos');
                    return;
                }

                // Validate products
                const validProducts = products.filter(p => 
                    p.code && p.name && p.category && 
                    typeof p.stock === 'number' && 
                    typeof p.min === 'number' && 
                    typeof p.max === 'number'
                );

                if (validProducts.length === 0) {
                    alert('‚ö†Ô∏è No se encontraron productos v√°lidos en el JSON');
                    return;
                }

                await confirmImport(validProducts);
            } catch (error) {
                alert('‚ùå Error al parsear JSON: ' + error.message);
            }
        }

        // Initialize on load
        window.addEventListener('load', initializeData);
    </script>
</body>
</html>
